import pandas as pd
import os
from pathlib import Path

def process_license_plates_in_directory():
    """
    自动遍历当前文件夹下的所有Excel文件，
    添加“车牌归属地（省）”和“车牌归属地（市）”两列，
    并将处理后的文件保存到新的子文件夹中。
    """
    # --- 【根据最新补充数据进行合并更新】全国车牌号开头与地区对应表 ---
    province_map = {
        # --- 北京市 ---
        '京A': '北京市-北京市', '京B': '北京市-北京市', '京C': '北京市-北京市', '京D': '北京市-北京市',
        '京E': '北京市-北京市', '京H': '北京市-北京市', '京J': '北京市-北京市', '京K': '北京市-北京市',
        '京L': '北京市-北京市', '京M': '北京市-北京市', '京N': '北京市-北京市', '京O': '北京市-北京市',
        '京V': '北京市-北京市', '京Y': '北京市-北京市',
        # --- 上海市 ---
        '沪A': '上海市-上海市', '沪B': '上海市-上海市', '沪C': '上海市-上海市', '沪D': '上海市-上海市',
        '沪E': '上海市-上海市', '沪F': '上海市-上海市', '沪G': '上海市-上海市', '沪H': '上海市-上海市',
        '沪J': '上海市-上海市', '沪K': '上海市-上海市', '沪L': '上海市-上海市', '沪M': '上海市-上海市',
        '沪N': '上海市-上海市', '沪R': '上海市-崇明区',
        # --- 天津市 ---
        '津A': '天津市-天津市', '津B': '天津市-天津市', '津C': '天津市-天津市', '津D': '天津市-天津市',
        '津E': '天津市-天津市', '津F': '天津市-天津市', '津G': '天津市-天津市', '津H': '天津市-天津市',
        # --- 重庆市 ---
        '渝A': '重庆市-重庆市', '渝B': '重庆市-重庆市', '渝C': '重庆市-永川区', '渝D': '重庆市-重庆市主城区',
        '渝F': '重庆市-万州区', '渝G': '重庆市-涪陵区', '渝H': '重庆市-黔江区',
        # --- 河北省 ---
        '冀A': '河北省-石家庄市', '冀B': '河北省-唐山市', '冀C': '河北省-秦皇岛市', '冀D': '河北省-邯郸市',
        '冀E': '河北省-邢台市', '冀F': '河北省-保定市', '冀G': '河北省-张家口市', '冀H': '河北省-承德市',
        '冀J': '河北省-沧州市', '冀R': '河北省-廊坊市', '冀S': '河北省-沧州市', '冀T': '河北省-衡水市',
        '冀X': '河北省-雄安新区',
        # --- 河南省 ---
        '豫A': '河南省-郑州市', '豫B': '河南省-开封市', '豫C': '河南省-洛阳市', '豫D': '河南省-平顶山市',
        '豫E': '河南省-安阳市', '豫F': '河南省-鹤壁市', '豫G': '河南省-新乡市', '豫H': '河南省-焦作市',
        '豫J': '河南省-濮阳市', '豫K': '河南省-许昌市', '豫L': '河南省-漯河市', '豫M': '河南省-三门峡市',
        '豫N': '河南省-商丘市', '豫P': '河南省-周口市', '豫Q': '河南省-驻马店市', '豫R': '河南省-南阳市',
        '豫S': '河南省-信阳市', '豫U': '河南省-济源市', '豫V': '河南省-郑州市',
        # --- 云南省 ---
        '云A': '云南省-昆明市', '云C': '云南省-昭通市', '云D': '云南省-曲靖市',
        '云E': '云南省-楚雄彝族自治州', '云F': '云南省-玉溪市', '云G': '云南省-红河哈尼族彝族自治州',
        '云H': '云南省-文山壮族苗族自治州', '云J': '云南省-思茅区', '云K': '云南省-西双版纳傣族自治州',
        '云L': '云南省-大理白族自治州', '云M': '云南省-保山市', '云N': '云南省-德宏傣族景颇族自治州',
        '云P': '云南省-丽江市', '云Q': '云南省-怒江傈僳族自治州', '云R': '云南省-迪庆藏族自治州',
        '云S': '云南省-临沧市',
        # --- 辽宁省 ---
        '辽A': '辽宁省-沈阳市', '辽B': '辽宁省-大连市', '辽C': '辽宁省-鞍山市', '辽D': '辽宁省-抚顺市',
        '辽E': '辽宁省-本溪市', '辽F': '辽宁省-丹东市', '辽G': '辽宁省-锦州市', '辽H': '辽宁省-营口市',
        '辽J': '辽宁省-阜新市', '辽K': '辽宁省-辽阳市', '辽L': '辽宁省-盘锦市', '辽M': '辽宁省-铁岭市',
        '辽N': '辽宁省-朝阳市', '辽P': '辽宁省-葫芦岛市', '辽V': '辽宁省-省直机关',
        # --- 黑龙江省 ---
        '黑A': '黑龙江省-哈尔滨市', '黑B': '黑龙江省-齐齐哈尔市', '黑C': '黑龙江省-牡丹江市',
        '黑D': '黑龙江省-佳木斯市', '黑E': '黑龙江省-大庆市', '黑F': '黑龙江省-伊春市',
        '黑G': '黑龙江省-鸡西市', '黑H': '黑龙江省-鹤岗市', '黑J': '黑龙江省-双鸭山市',
        '黑K': '黑龙江省-七台河市', '黑L': '黑龙江省-哈尔滨市(原松花江地区并入)', '黑M': '黑龙江省-绥化市',
        '黑N': '黑龙江省-黑河市', '黑P': '黑龙江省-大兴安岭地区', '黑R': '黑龙江省-农垦系统',
        # --- 湖南省 ---
        '湘A': '湖南省-长沙市', '湘B': '湖南省-株洲市', '湘C': '湖南省-湘潭市', '湘D': '湖南省-衡阳市',
        '湘E': '湖南省-邵阳市', '湘F': '湖南省-岳阳市', '湘G': '湖南省-张家界市', '湘H': '湖南省-益阳市',
        '湘J': '湖南省-常德市', '湘K': '湖南省-娄底市', '湘L': '湖南省-郴州市', '湘M': '湖南省-永州市',
        '湘N': '湖南省-怀化市', '湘U': '湖南省-湘西土家族苗族自治州',
        # --- 安徽省 ---
        '皖A': '安徽省-合肥市', '皖B': '安徽省-芜湖市', '皖C': '安徽省-蚌埠市', '皖D': '安徽省-淮南市',
        '皖E': '安徽省-马鞍山市', '皖F': '安徽省-淮北市', '皖G': '安徽省-铜陵市', '皖H': '安徽省-安庆市',
        '皖J': '安徽省-黄山市', '皖K': '安徽省-阜阳市', '皖L': '安徽省-宿州市', '皖M': '安徽省-滁州市',
        '皖N': '安徽省-六安市', '皖P': '安徽省-宣城市', '皖Q': '安徽省-巢湖市', '皖R': '安徽省-池州市',
        '皖S': '安徽省-亳州市',
        # --- 山东省 ---
        '鲁A': '山东省-济南市', '鲁B': '山东省-青岛市', '鲁C': '山东省-淄博市', '鲁D': '山东省-枣庄市',
        '鲁E': '山东省-东营市', '鲁F': '山东省-烟台市', '鲁G': '山东省-潍坊市', '鲁H': '山东省-济宁市',
        '鲁J': '山东省-泰安市', '鲁K': '山东省-威海市', '鲁L': '山东省-日照市', '鲁M': '山东省-滨州市',
        '鲁N': '山东省-德州市', '鲁P': '山东省-聊城市', '鲁Q': '山东省-临沂市', '鲁R': '山东省-菏泽市',
        '鲁S': '山东省-济南市(原莱芜市并入)', '鲁U': '山东省-青岛市', '鲁V': '山东省-潍坊市', '鲁Y': '山东省-烟台市',
        # --- 新疆维吾尔自治区 ---
        '新A': '新疆维吾尔自治区-乌鲁木齐市', '新B': '新疆维吾尔自治区-昌吉回族自治州', '新C': '新疆维吾尔自治区-石河子市',
        '新D': '新疆维吾尔自治区-奎屯市', '新E': '新疆维吾尔自治区-博尔塔拉蒙古自治州', '新F': '新疆维吾尔自治区-伊犁哈萨克自治州',
        '新G': '新疆维吾尔自治区-塔城地区', '新H': '新疆维吾尔自治区-阿勒泰地区', '新J': '新疆维吾尔自治区-克拉玛依市',
        '新K': '新疆维吾尔自治区-吐鲁番市', '新L': '新疆维吾尔自治区-哈密市', '新M': '新疆维吾尔自治区-巴音郭愣蒙古自治州',
        '新N': '新疆维吾尔自治区-阿克苏地区', '新P': '新疆维吾尔自治区-克孜勒苏柯尔克孜自治州', '新Q': '新疆维吾尔自治区-喀什地区',
        '新R': '新疆维吾尔自治区-和田地区',
        # --- 江苏省 ---
        '苏A': '江苏省-南京市', '苏B': '江苏省-无锡市', '苏C': '江苏省-徐州市', '苏D': '江苏省-常州市',
        '苏E': '江苏省-苏州市', '苏F': '江苏省-南通市', '苏G': '江苏省-连云港市', '苏H': '江苏省-淮安市',
        '苏J': '江苏省-盐城市', '苏K': '江苏省-扬州市', '苏L': '江苏省-镇江市', '苏M': '江苏省-泰州市',
        '苏N': '江苏省-宿迁市', '苏U': '江苏省-苏州市',
        # --- 浙江省 ---
        '浙A': '浙江省-杭州市', '浙B': '浙江省-宁波市', '浙C': '浙江省-温州市', '浙D': '浙江省-绍兴市',
        '浙E': '浙江省-湖州市', '浙F': '浙江省-嘉兴市', '浙G': '浙江省-金华市', '浙H': '浙江省-衢州市',
        '浙J': '浙江省-台州市', '浙K': '浙江省-丽水市', '浙L': '浙江省-舟山市',
        # --- 江西省 ---
        '赣A': '江西省-南昌市', '赣B': '江西省-赣州市', '赣C': '江西省-宜春市', '赣D': '江西省-吉安市',
        '赣E': '江西省-上饶市', '赣F': '江西省-抚州市', '赣G': '江西省-九江市', '赣H': '江西省-景德镇市',
        '赣J': '江西省-萍乡市', '赣K': '江西省-新余市', '赣L': '江西省-鹰潭市', '赣M': '江西省-南昌市',
        # --- 湖北省 ---
        '鄂A': '湖北省-武汉市', '鄂B': '湖北省-黄石市', '鄂C': '湖北省-十堰市', '鄂D': '湖北省-荆州市',
        '鄂E': '湖北省-宜昌市', '鄂F': '湖北省-襄阳市', '鄂G': '湖北省-鄂州市', '鄂H': '湖北省-荆门市',
        '鄂J': '湖北省-黄冈市', '鄂K': '湖北省-孝感市', '鄂L': '湖北省-咸宁市', '鄂M': '湖北省-仙桃市',
        '鄂N': '湖北省-潜江市', '鄂P': '湖北省-神农架林区', '鄂Q': '湖北省-恩施土家族苗族自治州',
        '鄂R': '湖北省-天门市', '鄂S': '湖北省-随州市', '鄂W': '湖北省-武汉市',
        # --- 广西壮族自治区 ---
        '桂A': '广西壮族自治区-南宁市', '桂B': '广西壮族自治区-柳州市', '桂C': '广西壮族自治区-桂林市',
        '桂D': '广西壮族自治区-梧州市', '桂E': '广西壮族自治区-北海市', '桂F': '广西壮族自治区-崇左市',
        '桂G': '广西壮族自治区-来宾市', '桂H': '广西壮族自治区-桂林市', '桂J': '广西壮族自治区-贺州市',
        '桂K': '广西壮族自治区-玉林市', '桂L': '广西壮族自治区-百色市', '桂M': '广西壮族自治区-河池市',
        '桂N': '广西壮族自治区-钦州市', '桂P': '广西壮族自治区-防城港市', '桂R': '广西壮族自治区-贵港市',
        # --- 甘肃省 ---
        '甘A': '甘肃省-兰州市', '甘B': '甘肃省-嘉峪关市', '甘C': '甘肃省-金昌市', '甘D': '甘肃省-白银市',
        '甘E': '甘肃省-天水市', '甘F': '甘肃省-酒泉市', '甘G': '甘肃省-张掖市', '甘H': '甘肃省-武威市',
        '甘J': '甘肃省-定西市', '甘K': '甘肃省-陇南市', '甘L': '甘肃省-平凉市', '甘M': '甘肃省-庆阳市',
        '甘N': '甘肃省-临夏回族自治州', '甘P': '甘肃省-甘南藏族自治州',
        # --- 山西省 ---
        '晋A': '山西省-太原市', '晋B': '山西省-大同市', '晋C': '山西省-阳泉市', '晋D': '山西省-长治市',
        '晋E': '山西省-晋城市', '晋F': '山西省-朔州市', '晋H': '山西省-忻州市', '晋J': '山西省-吕梁市',
        '晋K': '山西省-晋中市', '晋L': '山西省-临汾市', '晋M': '山西省-运城市',
        # --- 内蒙古自治区 ---
        '蒙A': '内蒙古自治区-呼和浩特市', '蒙B': '内蒙古自治区-包头市', '蒙C': '内蒙古自治区-乌海市',
        '蒙D': '内蒙古自治区-赤峰市', '蒙E': '内蒙古自治区-呼伦贝尔市', '蒙F': '内蒙古自治区-兴安盟',
        '蒙G': '内蒙古自治区-通辽市', '蒙H': '内蒙古自治区-锡林郭勒盟', '蒙J': '内蒙古自治区-乌兰察布市',
        '蒙K': '内蒙古自治区-鄂尔多斯市', '蒙L': '内蒙古自治区-巴彦淖尔市', '蒙M': '内蒙古自治区-阿拉善盟',
        # --- 陕西省 ---
        '陕A': '陕西省-西安市', '陕B': '陕西省-铜川市', '陕C': '陕西省-宝鸡市', '陕D': '陕西省-咸阳市',
        '陕E': '陕西省-渭南市', '陕F': '陕西省-汉中市', '陕G': '陕西省-安康市', '陕H': '陕西省-商洛市',
        '陕J': '陕西省-延安市', '陕K': '陕西省-榆林市', '陕U': '陕西省-西安市', '陕V': '陕西省-杨凌区',
        # --- 吉林省 ---
        '吉A': '吉林省-长春市', '吉B': '吉林省-吉林市', '吉C': '吉林省-四平市', '吉D': '吉林省-辽源市',
        '吉E': '吉林省-通化市', '吉F': '吉林省-白山市', '吉G': '吉林省-白城市', '吉H': '吉林省-延边朝鲜族自治州',
        '吉J': '吉林省-松原市', '吉K': '吉林省-长白朝鲜族自治县',
        # --- 福建省 ---
        '闽A': '福建省-福州市', '闽B': '福建省-莆田市', '闽C': '福建省-泉州市', '闽D': '福建省-厦门市',
        '闽E': '福建省-漳州市', '闽F': '福建省-龙岩市', '闽G': '福建省-三明市', '闽H': '福建省-南平市',
        '闽J': '福建省-宁德市', '闽K': '福建省-省直系统',
        # --- 贵州省 ---
        '贵A': '贵州省-贵阳市', '贵B': '贵州省-六盘水市', '贵C': '贵州省-遵义市', '贵D': '贵州省-铜仁市',
        '贵E': '贵州省-黔西南布依族苗族自治州', '贵F': '贵州省-毕节市', '贵G': '贵州省-安顺市',
        '贵H': '贵州省-黔东南苗族侗族自治州', '贵J': '贵州省-黔南布依族苗族自治州',
        # --- 广东省 ---
        '粤A': '广东省-广州市', '粤B': '广东省-深圳市', '粤C': '广东省-珠海市', '粤D': '广东省-汕头市',
        '粤E': '广东省-佛山市', '粤F': '广东省-韶关市', '粤G': '广东省-湛江市', '粤H': '广东省-肇庆市',
        '粤J': '广东省-江门市', '粤K': '广东省-茂名市', '粤L': '广东省-惠州市', '粤M': '广东省-梅州市',
        '粤N': '广东省-汕尾市', '粤P': '广东省-河源市', '粤Q': '广东省-阳江市', '粤R': '广东省-清远市',
        '粤S': '广东省-东莞市', '粤T': '广东省-中山市', '粤U': '广东省-潮州市', '粤V': '广东省-揭阳市',
        '粤W': '广东省-云浮市', '粤X': '广东省-顺德区', '粤Y': '广东省-南海区', '粤Z': '广东省-港澳进入内地车辆',
        # --- 四川省 ---
        '川A': '四川省-成都市', '川B': '四川省-绵阳市', '川C': '四川省-自贡市', '川D': '四川省-攀枝花市',
        '川E': '四川省-泸州市', '川F': '四川省-德阳市', '川G': '四川省-成都市', '川H': '四川省-广元市',
        '川J': '四川省-遂宁市', '川K': '四川省-内江市', '川L': '四川省-乐山市', '川M': '四川省-资阳市',
        '川Q': '四川省-宜宾市', '川R': '四川省-南充市', '川S': '四川省-达州市', '川T': '四川省-雅安市',
        '川U': '四川省-阿坝藏族羌族自治州', '川V': '四川省-甘孜藏族自治州', '川W': '四川省-凉山彝族自治州',
        '川X': '四川省-广安市', '川Y': '四川省-巴中市', '川Z': '四川省-眉山市',
        # --- 青海省 ---
        '青A': '青海省-西宁市', '青B': '青海省-海东市', '青C': '青海省-海北藏族自治州', '青D': '青海省-黄南藏族自治州',
        '青E': '青海省-海南藏族自治州', '青F': '青海省-果洛藏族自治州', '青G': '青海省-玉树藏族自治州',
        '青H': '青海省-海西蒙古族藏族自治州',
        # --- 西藏自治区 ---
        '藏A': '西藏自治区-拉萨市', '藏B': '西藏自治区-昌都市', '藏C': '西藏自治区-山南市', '藏D': '西藏自治区-日喀则市',
        '藏E': '西藏自治区-那曲市', '藏F': '西藏自治区-阿里地区', '藏G': '西藏自治区-林芝市',
        '藏H': '西藏自治区-驻四川省天全县车辆管理所', '藏J': '西藏自治区-驻青海省格尔木市车辆管理所',
        # --- 海南省 ---
        '琼A': '海南省-海口市', '琼B': '海南省-三亚市', '琼C': '海南省-琼海市', '琼D': '海南省-五指山市',
        '琼E': '海南省-洋浦开发区', '琼F': '海南省-儋州市',
        # --- 宁夏回族自治区 ---
        '宁A': '宁夏回族自治区-银川市', '宁B': '宁夏回族自治区-石嘴山市', '宁C': '宁夏回族自治区-吴忠市',
        '宁D': '宁夏回族自治区-固原市', '宁E': '宁夏回族自治区-中卫市',
    }

    def get_location_parts(plate_number):
        # 确保输入是字符串类型
        if not isinstance(plate_number, str) or len(plate_number) < 2:
            return '未知', '未知'
        
        prefix = plate_number[:2]
        location_full = province_map.get(prefix, '未知-未知')
        
        # 拆分省份和城市信息
        parts = location_full.split('-', 1) # 使用1作为参数，确保只分割一次
        if len(parts) == 2:
            return parts[0], parts[1]
        else:
            # 如果没有'-'分隔符，则省份和城市设为相同
            return parts[0], parts[0]


    # 1. 获取当前脚本所在的目录
    current_dir = Path.cwd()
    output_dir = current_dir / "处理后表格"

    # 2. 创建输出文件夹
    output_dir.mkdir(exist_ok=True)
    
    print(f"将在 '{current_dir}' 文件夹中查找Excel文件...")
    print(f"处理后的文件将保存在 '{output_dir}' 中。")
    print("-" * 30)

    # 3. 查找所有Excel文件
    excel_files = list(current_dir.glob('*.xlsx')) + list(current_dir.glob('*.xls'))

    if not excel_files:
        print("未在当前文件夹中找到任何Excel文件。")
        return

    # 4. 遍历并处理每个文件
    for file_path in excel_files:
        print(f"正在处理: {file_path.name}")
        try:
            # 根据文件扩展名选择合适的引擎读取Excel文件
            engine = 'openpyxl' if file_path.suffix == '.xlsx' else 'xlrd'
            df = pd.read_excel(file_path, engine=engine)

            # 检查是否存在“车牌号”列
            if '车牌号' not in df.columns:
                print(f"  -> 跳过: 文件 '{file_path.name}' 中未找到“车牌号”列。")
                continue

            # 应用函数，获取省和市
            location_data = df['车牌号'].apply(get_location_parts)
            df['车牌归属地（省）'] = location_data.apply(lambda x: x[0])
            df['车牌归属地（市）'] = location_data.apply(lambda x: x[1])

            # 调整列顺序，将新列放在“车牌号”列前面
            # 首先移除可能已存在的旧列，以防重复运行脚本时出错
            original_cols = [col for col in df.columns if col not in ['车牌归属地（省）', '车牌归属地（市）']]
            
            # 找到“车牌号”的位置
            try:
                plate_col_index = original_cols.index('车牌号')
                # 将新列插入到'车牌号'之前
                new_cols = original_cols[:plate_col_index] + ['车牌归属地（省）', '车牌归属地（市）'] + original_cols[plate_col_index:]
            except ValueError:
                # 如果没有'车牌号'列，则将新列放在最前面
                new_cols = ['车牌归属地（省）', '车牌归属地（市）'] + original_cols

            df = df[new_cols]

            # 定义输出路径
            output_path = output_dir / file_path.name
            
            # 保存到新的Excel文件
            df.to_excel(output_path, index=False)
            print(f"  -> 完成: 已保存至 '{output_path}'")

        except Exception as e:
            print(f"  -> 错误: 处理文件 '{file_path.name}' 时发生错误: {e}")
    
    print("-" * 30)
    print("所有文件处理完毕！")


# --- 使用说明 ---
# 1. 安装所需库 (如果还没安装的话):
#    pip install pandas openpyxl xlrd
#
# 2. 将此Python脚本文件（例如 process_plates.py）和所有需要处理的Excel文件放在同一个文件夹下。
#
# 3. 直接运行此脚本，程序会自动完成所有操作。

if __name__ == '__main__':
    process_license_plates_in_directory()
